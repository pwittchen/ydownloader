#!/usr/bin/env bash

set -e # automatically exit script on error

function showHelp() {
  echo "
        ydownloader is a script responsible
        for downloading SAP Hybris Commerce Suite from Artifactory

        Usage:
          -d    downloading Commerce Suite
          -u    showing Commerce Suite Download Url
          -t    showing Commerce Suite Release Time
          -h    showing help
        "
}

function setCommerceSuiteVersion() {
  echo -n "SAP Hybris Commerce Suite version (leave empty for the latest): "
  read COMMERCE_SUITE_VERSION
}

function setArtifactType() {
  echo -n "Set artifact type (release or snapshot - leave empty for release): "
  read ARTIFACT_TYPE

  if [ "$ARTIFACT_TYPE" == "" ]
  then
    ARTIFACT_TYPE="release"
  fi
}

function setUsernameAndPassword() {
  echo -n "SAP username (e-mail): "
  read USERNAME
  echo -n "SAP password: "
  read -s PASSWORD
}

function setCommerceSuiteDownloadUrl() {
  setCommerceSuiteVersion
  setArtifactType
  setUsernameAndPassword

  echo $'\ngetting Commerce Suite details from Artifactory...'

  setDownloadEndpoint
}

# extracts value of a given parameter from JSON data
function extractValueFromJson() {
  python -mjson.tool | grep $1 | tail -1 | awk '{print $2}' | sed -e 's/^"//' -e 's/"$//'
}

# cut last n-1 chars
function cutLastChars() {
  rev | cut -c "$1"- | rev
}

# get first endpoint for downloading Commerce Suite through Artifactory REST API
function setDownloadEndpoint() {
  setResponseWithUrlEndpoint
  COMMERCE_SUITE_DOWNLOAD_URL_ENDPOINT=`echo $RESPONSE_WITH_URL_ENDPOINT | extractValueFromJson zip`
}

function setResponseWithUrlEndpoint() {
  API_URL="https://repository.hybris.com/api"
  RESPONSE_WITH_URL_ENDPOINT=$(curl -s -u $USERNAME:$PASSWORD \
  $API_URL/search/artifact\?name\=commerce-suite-$COMMERCE_SUITE_VERSION\&repos\=hybris-$ARTIFACT_TYPE)
}

# get exact url of Commerce Suite from previously extracted endpoint
function setDownloadZipFileUrl() {
  setResponseUrlWithDetails
  COMMERCE_SUITE_URL_ZIP_FILE=$(parseResponse downloadUri)
}

function setResponseUrlWithDetails() {
  RESPONSE_URL_WITH_DETAILS=$(curl -s -u $USERNAME:$PASSWORD $COMMERCE_SUITE_DOWNLOAD_URL_ENDPOINT)
}

function parseResponse() {
  echo $RESPONSE_URL_WITH_DETAILS | extractValueFromJson $1 | cutLastChars 3
}

function showCommerceSuiteDownloadUrl() {
  setCommerceSuiteDownloadUrl
  setDownloadZipFileUrl
  echo $COMMERCE_SUITE_URL_ZIP_FILE
}

function showCommerceSuiteReleaseTime() {
  setCommerceSuiteDownloadUrl
  setResponseUrlWithDetails
  echo $(parseResponse lastUpdated)
}

function downloadCommerceSuite() {
  setCommerceSuiteDownloadUrl
  setDownloadZipFileUrl
  echo $'\nstarting download of Commerce Suite from Artifactory...'
  wget --http-user=$USERNAME --http-password=$PASSWORD $COMMERCE_SUITE_URL_ZIP_FILE
}

OPTIND=1 # Reset in case getopts has been used previously in the shell.

while getopts "hutd" opt; do
    case "$opt" in
    h)
        showHelp
        exit 0
        ;;
    u)  showCommerceSuiteDownloadUrl
        ;;
    t)  showCommerceSuiteReleaseTime
        ;;
    d)  downloadCommerceSuite
        ;;
    esac
done

shift $((OPTIND-1))

[ "$1" = "--" ] && shift
